<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/edicao.css">
    <link rel="stylesheet" href="css/navbar.css">
    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
    <title>Edição</title>
</head>

<body>
    <!-- CABEÇALHO -->
    <!---------------NAVBAR-------------------------------------------------->
    <div class="navbar-caixa">
        <div class="conteudo-nav">
            <div class="texto-nav">Editar/Excluir Itens</div>

            <button id="menu-btn" class="menu-btn">&#9776;</button>
        </div>

        <!--------------------------------HAMBURGUER------------------------------------------------------------------------------------>
        <div id="sidebar" class="sidebar">
            <button id="close-btn" class="close-btn">&times;</button>
            <img src="imglogineusuario/senaibranco.svg" alt="" />
            <h3>Menu</h3>
            <ul>


                <li class="home">
                    <a href="telaInicial.html" id="home">
                        <div class="home"></div>
                        <span>Home</span>
                    </a>
                </li>


                <li class="cadastrar">
                    <a href="cadastro1.html" id="cadas">
                        <div class="box-of-good-good"></div>
                        <span>Cadastrar</span>
                    </a>
                </li>


                <li class="edicao">
                    <a href="edicao.html" id="edicao">
                        <div class="pencil"></div>
                        <span>Edição</span>
                    </a>
                </li>


                <li class="estoque-item">
                    <a href="#" id="esto" class="estoque-link">
                        <div class="boxes-of-good-good"></div>
                        <span>Estoque</span>
                    </a>
                    <ul id="estoque-submenu" class="submenu">
                        <li><a href="catalogo.html">Catálogo</a></li>
                        <li><a href="estoque_real.html">Estoque Real e Inventário</a></li>
                        <li><a href="layout.html">Layout do Estoque</a></li>
                    </ul>
                </li>


                <li class="financeiro">
                    <a href="financeiro.html" id="finan">
                        <div class="financial"></div>
                        <span>Financeiro</span>
                    </a>
                </li>
            </ul>

            <div class="container-logos">
                <h4>SGA - Sistema de Gerenciamento de Armazém</h4>
                <img src="imagens/logo-emp.svg" id="logo-gato" alt="" /><img src="imagens/logo-soft.svg"
                    id="logo-cubo" />
            </div>
        </div>
    </div>
    <!-------------------------------------------------------------------------------------------------------------------------------->

    <!-- ----------------------------------------------------------------------------------------------------------------------------- -->

    <div class="popup-edicao">
        <div class="conteudo">
            <div class="titulo-edicao">Edição</div>
            <!-- /* ---------------------------------------------------------------------------------------- */ -->
            <div class="secao1">
                <img src="imagens/Foto(Edição).svg" alt="" id="foto">
                <div class="informacoesbasicas">
                    <div class="titulo-edicao">Informações Básicas</div>
                    <div class="inputs1">
                        <div class="nome_b">Nome Básico:<input type="text" class="input" id="nome_b"></div>
                        <div class="nome_m">Nome Modificador:<input type="text" class="input" id="nome_m"></div>
                        <div class="categoria">Categoria:<input type="text" class="input" id="categoria"></div>
                        <div class="cod">Cód. Barras:<input type="number" class="input" id="cod"></div>
                        <div class="descricao">Descrição Técnica:<input type="text" class="input" id="descricao"></div>
                        <div class="fabricante">Fabricante:<input type="text" class="input" id="fabricante"></div>
                    </div>
                </div>
            </div>
            <!-- /* ---------------------------------------------------------------------------------------- */ -->
            <div class="secao2">
                <div class="detalhesdoproduto">
                    <div class="titulo-edicao">Detalhes do Produto</div>
                    <div class="inputs2">
                        <div class="observacao">Observação Adicional:<input type="text" class="input" id="observacao">
                        </div>
                        <div class="unidade">Unidade:<input type="text" class="input" id="unidade"></div>
                        <div class="preco_v">Preço de Venda:<input type="number" class="input" id="preco_v"></div>
                        <div class="fragilidade">
                            Fragilidade:<br>
                            <label>
                                <input type="radio" name="fragilidade" id="fragilidade-sim" value="1"> Sim
                            </label>
                            <label>
                                <input type="radio" name="fragilidade" id="fragilidade-nao" value="0"> Não
                            </label>
                        </div>
                    </div>
                </div>
                <div class="lote">
                    <div class="titulo-edicao">Lote</div>
                    <div class="inputs2">
                        <div></div>
                    </div>
                </div>
            </div>
            <!-- /* ---------------------------------------------------------------------------------------- */ -->
            <div class="secao3">
                <div class="dadosfisicos">
                    <div class="titulo-edicao">Dados Físicos:</div>
                    <div class="inputs2">
                        <div class="altura">Altura:<input type="number" class="input" id="altura"></div>
                        <div class="largura">Largura:<input type="number" class="input" id="largura"></div>
                        <div class="profundidade">Profundidade:<input type="number" class="input" id="profundidade">
                        </div>
                        <div class="peso">Peso:<input type="number" class="input" id="peso"></div>
                    </div>
                </div>
                <div class="localizacao">
                    <div class="titulo-edicao">Localização:</div>
                    <div class="inputs3">
                        <div class="rua">Rua:<input type="number" class="input" id="rua"></div>
                        <div class="coluna">Coluna:<input type="number" class="input" id="coluna"></div>
                        <div class="andar">Andar:<input type="number" class="input" id="andar"></div>
                    </div>
                </div>
                <button class="salvar_edicao">Salvar</button>
            </div>

        </div>
    </div>

    <!-- ----------------------------------------------------------------------------------------------------------------------------- -->

    <!-- <div class="cabeca">Editar/Excluir Itens</div> -->

    <div class="div_pesquisa">
        <button id="filtrar"><img src="imagens/filtro.svg" alt="" id="fil">Filtrar</button>
        <input type="text" id="pesquisa">
        <button id="pesquisar">Pesquisar <img src="imagens/lupa.svg" alt="" id="pes"></button>
    </div>

    <!-- ----------------------------------------------------------------------------------------------------------------------------- -->

    <div class="container">
        <div class="content-table">
            <table id="tabela-estoque">

                <thead>
                    <tr>
                        <th>Código de Barras</th>
                        <th>Nome Básico</th>
                        <th>Nome Modificado</th>
                        <th>Descrição Tecnica</th>
                        <th>Fabricante</th>
                        <th class="none">Observação Adicional</th>
                        <th class="none">Unidade</th>
                        <th class="none">Preço de Venda</th>
                        <th class="none">Fragilidade</th>
                        <th class="none">Altura</th>
                        <th class="none">Largura</th>
                        <th class="none">Profundidade</th>
                        <th class="none">Peso</th>
                        <th class="none">Rua</th>
                        <th class="none">Coluna</th>
                        <th class="none">Andar</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>


            </table>
        </div>
    </div>

    <!-- ----------------------------------------------------------------------------------------------------------------------------- -->

    <!-- Pop-up de Senha -->

    <div id="senha-popup" class="popup">
        <div class="popup-content">
            <div class="titulo">Digite a senha do Professor para a exclusão:</div>
            <input type="password" id="senha-input" placeholder="Senha">
            <div class="posicaobotao">
                <button id="senha-cancelar" onclick="cancelarSenha()">Cancelar</button>
                <button id="senha-confirmar" onclick="verificarSenha()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ----------------------------------------------------------------------------------------------------------------------------- -->

    <script>



        document.addEventListener('click', function (e) {
            // Verifica se o clique foi fora do pop-up de edição
            const popupEdicao = document.querySelector('.popup-edicao');
            const content = document.querySelector('.popup-edicao .conteudo');

            // Se o clique foi fora do conteúdo do pop-up, fecha o pop-up
            if (popupEdicao && !content.contains(e.target)) {
                popupEdicao.style.display = 'none';
            }

            // Verifica se o clique foi dentro da área da imagem do lápis (para abrir o pop-up de edição)
            if (e.target.closest('.imagemlapis')) {
                const row = e.target.closest('tr');
                const dataCells = row.querySelectorAll('td');

                // Associa os campos do banco de dados com os inputs
                const mapping = {
                    CODIGO: 'cod',
                    NOME_BASICO: 'nome_b',
                    NOME_MODIFICADOR: 'nome_m',
                    DESCRICAO_TECNICA: 'descricao',
                    FABRICANTE: 'fabricante',
                    OBSERVACOES_ADICIONAL: 'observacao',
                    UNIDADE: 'unidade',
                    PRECO_DE_VENDA: 'preco_v',
                    FRAGILIDADE: 'fragilidade',
                    ALTURA: 'altura',
                    LARGURA: 'largura',
                    PROFUNDIDADE: 'profundidade',
                    PESO: 'peso',
                    RUA: 'rua',
                    COLUNA: 'coluna',
                    ANDAR: 'andar'
                };

                // Preencher inputs com base no mapeamento
                Object.keys(mapping).forEach((key, index) => {
                    const inputId = mapping[key];
                    const cell = dataCells[index]; // Assume que os índices dos <td> correspondem
                    if (cell && document.getElementById(inputId)) {
                        if (inputId === 'fragilidade') {
                            const fragilidadeValue = cell?.textContent.trim().toLowerCase() || ''; // Normaliza o texto para minúsculas e evita valores nulos
                            const isFragile = fragilidadeValue === 'sim' || fragilidadeValue === '1' || fragilidadeValue === 'true';
                            const isNotFragile = fragilidadeValue === 'não' || fragilidadeValue === '0' || fragilidadeValue === 'false';

                            document.getElementById('fragilidade-sim').checked = isFragile;
                            document.getElementById('fragilidade-nao').checked = isNotFragile;
                        } else {
                            document.getElementById(inputId).value = cell.textContent.trim();
                        }
                    }
                });

                // Mostrar o pop-up
                document.querySelector('.popup-edicao').style.display = 'flex';
            }
        });


        document.querySelector('.salvar_edicao').addEventListener('click', async function () {
            const mapping = {
                codigo: 'cod',
                nomeBasico: 'nome_b',
                nomeModificador: 'nome_m',
                descricaoTecnica: 'descricao',
                fabricante: 'fabricante',
                observacoesAdicional: 'observacao',
                unidade: 'unidade',
                precoVenda: 'preco_v',
                fragilidade: 'fragilidade',
                altura: 'altura',
                largura: 'largura',
                profundidade: 'profundidade',
                peso: 'peso',
                rua: 'rua',
                coluna: 'coluna',
                andar: 'andar'
            };

            const updatedData = {};
            Object.keys(mapping).forEach(key => {
                const inputId = mapping[key];
                if (inputId === 'fragilidade') {
                    updatedData[key] = document.getElementById('fragilidade-sim').checked ? 1 : 0;
                } else {
                    updatedData[key] = document.getElementById(inputId)?.value || '';
                }
            });

            try {
                const response = await fetch('/editar-produto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData),
                });

                if (response.ok) {
                    alert('Produto atualizado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao atualizar o produto.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar os dados.');
            }
        });


        // <!-- -------------------------------------HAMBURGUER----------------------------------------------------------- -->

        document.addEventListener('DOMContentLoaded', function () {

            const estoqueItem = document.querySelector('.estoque-item');
            const estoqueSubMenu = document.getElementById('estoque-submenu');
            const estoqueLink = document.getElementById('esto');
            const iconeEstoque = estoqueLink.querySelector('.boxes-of-good-good');

            const submenuLinks = estoqueSubMenu.querySelectorAll('a');
            submenuLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.stopPropagation();
                });
            });

            estoqueItem.addEventListener('click', function (event) {
                event.preventDefault();

                estoqueItem.classList.toggle('active');
                if (estoqueItem.classList.contains('active')) {
                    estoqueSubMenu.style.display = "block";
                    estoqueItem.style.backgroundColor = "#000";
                    estoqueLink.style.color = "#319DF6";
                    iconeEstoque.style.backgroundImage = "url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%23319df6' d='M10 4v11h12V4zm2 2h2v4l2-2l2 2V6h2v7h-8zM3 17v11h12V17zm14 0v11h12V17zM5 19h2v4l2-2l2 2v-4h2v7H5zm14 0h2v4l2-2l2 2v-4h2v7h-8z'/%3E%3C/svg%3E\")";
                } else {
                    estoqueSubMenu.style.display = "none";
                    estoqueItem.style.backgroundColor = "";
                    estoqueLink.style.color = "";
                    iconeEstoque.style.backgroundImage = "";
                }
            });

            // Fecha o dropdown ao clicar fora
            document.addEventListener('click', function (event) {
                if (!estoqueItem.contains(event.target)) {
                    estoqueItem.classList.remove('active');
                    estoqueSubMenu.style.display = "none";
                    estoqueItem.style.backgroundColor = "";
                    estoqueLink.style.color = "";
                    iconeEstoque.style.backgroundImage = "";
                }
            });


        });

        // <!-- -------------------------------------Mostrar a Tabela----------------------------------------------------------- -->

        async function fetchProdutosCatalogo() {
            try {
                const response = await fetch('/ver-catalogo');

                if (!response.ok) {
                    throw new Error('Erro ao buscar produtos: ' + response.statusText);
                }

                const produtos = await response.json();

                const tbody = document.querySelector('#tabela-estoque tbody');
                tbody.innerHTML = '';

                if (produtos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Nenhum produto encontrado</td></tr>';
                    return;
                }

                produtos.forEach(produto => {
                    const row = `
                    <tr id="produto-${produto.CODIGO}">
                        <td>${produto.CODIGO}</td>
                        <td>${produto.NOME_BASICO}</td>
                        <td>${produto.NOME_MODIFICADOR}</td>
                        <td>${produto.DESCRICAO_TECNICA}</td>
                        <td>${produto.FABRICANTE}</td>
                        <td class="none">${produto.OBSERVACOES_ADICIONAL}</td>
                        <td class="none">${produto.UNIDADE}</td>
                        <td class="none">${produto.PRECO_DE_VENDA}</td>
                        <td class="none">${produto.FRAGILIDADE}</td>
                        <td class="none">${produto.ALTURA}</td>
                        <td class="none">${produto.LARGURA}</td>
                        <td class="none">${produto.PROFUNDIDADE}</td>
                        <td class="none">${produto.PESO}</td>
                        <td class="none">${produto.RUA}</td>
                        <td class="none">${produto.COLUNA}</td>
                        <td class="none">${produto.ANDAR}</td>
                        <td class="lixeira">
                            <img src="imagens/Lixeira(Normal).svg" alt="Lixeira" class="imagemlixeira" onmouseover="this.src='imagens/Lixeira(Modificado).svg';" onmouseout="this.src='imagens/Lixeira(Normal).svg';" onclick="excluirProduto(${produto.CODIGO})">
                        </td>
                        <td class="lapis">
                            <img src="imagens/Lapis(Normal).svg" alt="Lápis" class="imagemlapis" onmouseover="this.src='imagens/Lapis(Modificado).svg';" onmouseout="this.src='imagens/Lapis(Normal).svg';">
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                alert('Erro ao buscar produtos: ' + error.message);
            }
        }

        // <!-- -------------------------------------Excluir/Deletar Item----------------------------------------------------------- -->

        let codigoProdutoExcluido = null;  // Variável global para guardar o código do produto

        // Exibe o pop-up de senha
        function excluirProduto(codigo) {
            codigoProdutoExcluido = codigo;  // Salva o código do produto a ser excluído
            document.getElementById('senha-popup').style.display = 'flex';  // Exibe o pop-up
        }

        // Função para verificar a senha
        function verificarSenha() {
            const senha = document.getElementById('senha-input').value;

            if (senha !== 'professor123') {
                alert('Senha incorreta!');
                return;
            }

            // Realiza a exclusão do produto se a senha for correta
            fetch('/deletar-produto', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ codigo: codigoProdutoExcluido, senha: senha })
            })
                .then(response => response.text())
                .then(message => {
                    console.log(message);
                    if (message.includes('sucesso')) {
                        document.querySelector(`#produto-${codigoProdutoExcluido}`).remove();
                    } else {
                        alert(message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir produto');
                });

            // Fecha o pop-up
            cancelarSenha();
        }

        // Fecha o pop-up sem fazer nada

        function cancelarSenha() {
            document.getElementById('senha-popup').style.display = 'none';
            document.getElementById('senha-input').value = '';  // Limpa o campo da senha
        }




        window.onload = fetchProdutosCatalogo;

    </script>

<script>
 
    document.getElementById('formFiltrar').addEventListener('submit', async (event) => {
       event.preventDefault(); // Impede o recarregamento da página
   
       const fabricante = document.getElementById('fabricanteFiltro').value;
       const codigo = document.getElementById('codigo').value;
       const ordenacao = document.getElementById('ordenacao').value; // Captura a ordenação
   
       try {
           const response = await fetch('/filtro-catalogo', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ fabricante, codigo, ordenacao }) // Envia os dados ao backend
           });
   
           if (response.ok) {
               const produtosFiltrados = await response.json();
   
               const tbody = document.querySelector('#tabela-estoque tbody');
               tbody.innerHTML = ''; // Limpa os dados antigos
   
               if (produtosFiltrados.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="7">Nenhum produto encontrado</td></tr>';
                   return;
               }
   
               produtosFiltrados.forEach(filtrado => {     
                   const row = `
                       <tr id="produto-${filtrado.CODIGO}">
                           <td>${filtrado.CODIGO}</td>
                           <td>${filtrado.NOME_BASICO}</td>
                           <td>${filtrado.DESCRICAO_TECNICA}</td>
                           <td>${filtrado.QUANT}</td>
                           <td>${filtrado.CATEGORIA || 'Indefinido'}</td>
                           <td>${filtrado.FABRICANTE}</td>
                           <td class="lixeira">
                               <img src="imagens/Lixeira(Normal).svg" alt="Lixeira" class="imagemlixeira" onmouseover="this.src='imagens/Lixeira(Modificado).svg';" onmouseout="this.src='imagens/Lixeira(Normal).svg';" onclick="excluirProduto(${filtrado.CODIGO})">
                           </td>
                           <td class="lapis">
                               <img src="imagens/Lapis(Normal).svg" alt="Lápis" class="imagemlapis" onmouseover="this.src='imagens/Lapis(Modificado).svg';" onmouseout="this.src='imagens/Lapis(Normal).svg';">
                           </td>
                       </tr>
                   `;
                   tbody.innerHTML += row;
               });
           } else {
               console.error('Erro ao obter produtos:', await response.text());
           }
       } catch (error) {
           console.error('Erro na requisição:', error);
       }
   });
   
   </script>
   
   <!---->
   
   <script>
       
    document.getElementById('formPesquisa').addEventListener('submit', async function (event) {
       event.preventDefault(); // Evita o comportamento padrão do formulário
   
       const pesquisa = {
           codigo: document.getElementById('codigo').value,  // Obtendo o valor do campo 'codigo'
       };
   
       try {
           const response = await fetch('http://localhost:3000/ver-catalogo', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(pesquisa), // Envia os dados para o backend
           });
   
           if (response.ok) {
               const produtos = await response.json();  // Resposta em formato JSON
   
               if (produtos.length === 0) {
                   alert('Nenhum produto encontrado!');
                   return;
               }
   
               const tbody = document.querySelector('#tabela-estoque tbody');
               tbody.innerHTML = '';  // Limpa a tabela antes de adicionar novos dados
   
               produtos.forEach((produto) => {
                   const row = `
                   <tr>
                       <td>${produto.CODIGO}</td>
                       <td>${produto.NOME_BASICO}</td>
                       <td>${produto.DESCRICAO_TECNICA}</td>
                       <td>${produto.QUANT}</td>
                       <td>${produto.CATEGORIA}</td>
                       <td>${produto.FABRICANTE}</td>
                       <td class="colunaAbrirDetalhes" id="${produto.CODIGO}">
                           <button onclick="abrirLinha()" class="btnAbrirLinha" id="${produto.CODIGO}">+</button>
                       </td>
                   </tr>
                   <tr id="linhaDetalhe" style="display: none;">
                       <td colspan="6">
                           <div class="containerLinhaOculta">
                               <div class="containerLinhaDetalhes">
                                   <div class="imagemProduto">
                                       <img src="https://img.kalunga.com.br/fotosdeprodutos/124209d.jpg" alt="" id="imagemLinhaDetalhe">
                                   </div>
                                   <div class="endereco-obs">
                                       <table>
                                           <thead>
                                               <th colspan="2">Endereçamento</th>
                                           </thead>
                                           <tbody id="tableEnderecamento">
                                               <tr>
                                                   <td id="colunaTopico" class="celulaDetalhe">Rua</td>
                                                   <td class="celulaDetalhe">${produto.RUA}</td>
                                               </tr>
                                               <tr>
                                                   <td id="colunaTopico" class="celulaDetalhe">Coluna</td>
                                                   <td class="celulaDetalhe">${produto.COLUNA}</td>
                                               </tr>
                                               <tr>
                                                   <td id="colunaTopico" class="celulaDetalhe">Andar</td>
                                                   <td class="celulaDetalhe">${produto.ANDAR}</td>
                                               </tr>
                                           </tbody>
                                       </table>
                                       <table>
                                            <thead>
                                               <th id="tableObservacoes">Observações</th>
                                           </thead>
                                           <tbody>
                                               <tr>
                                                   <td id="celulaObservacoes">${produto.OBSERVACOES_ADICIONAL}</td>
                                               </tr>
                                           </tbody>
                                       </table>
                                   </div>
                                   <div class="caractProd">
                                       <table>
                                       <thead>
                                           <th colspan="2">Características</th>
                                       </thead>
                                       <tbody id="tableCaracter">
                                           <tr>
                                               <td id="colunaTopico">Largura</td>
                                               <td class="celulaDetalhe">${produto.LARGURA} cm</td>
                                           </tr>
                                           <tr>
                                               <td id="colunaTopico">Altura</td>
                                               <td class="celulaDetalhe">${produto.ALTURA} cm</td>
                                           </tr>
                                           <tr>
                                               <td id="colunaTopico">Profundidade</td>
                                               <td class="celulaDetalhe">${produto.PROFUNDIDADE} cm</td>
                                           </tr>
                                           <tr>
                                               <td id="colunaTopico">Peso</td>
                                               <td class="celulaDetalhe">${produto.PESO} Kg</td>
                                           </tr>
                                           <tr>
                                               <td id="colunaTopico">Frágil</td>
                                               <td class="celulaDetalhe">${produto.FRAGILIDADE}</td>
                                           </tr>
                                       </tbody>
                                       </table>
                                   </div>
                               </div>
                           </div>
                       </td>
                   </tr>
                   `;
                   tbody.innerHTML += row;  // Adiciona a linha à tabela
               });
           } else {
               const errorMessage = await response.text();
               alert('Erro: ' + errorMessage);
           }
       } catch (error) {
           alert('Erro ao buscar produtos: ' + error.message);
       }
   });
   
</script>
<!-- ----------------------------------------------------------------------------------------------------------------------------- -->

    <div class="final"><img src="imagens/logo(escura).svg" id="logo">©DEVS-SENAI-SP - 2024</div>


</body>

<script src="js/edicao.js"></script>
<script src="js/navbar.js"></script>



</html>